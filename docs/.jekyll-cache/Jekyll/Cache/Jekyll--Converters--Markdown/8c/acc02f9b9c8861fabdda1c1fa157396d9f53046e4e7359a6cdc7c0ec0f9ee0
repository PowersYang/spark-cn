I"Å<ul id="markdown-toc">
  <li><a href="#èµ·å§‹ç‚¹sparksession" id="markdown-toc-èµ·å§‹ç‚¹sparksession">èµ·å§‹ç‚¹ï¼šSparkSession</a></li>
  <li><a href="#åˆ›å»ºdataframe" id="markdown-toc-åˆ›å»ºdataframe">åˆ›å»ºDataFrame</a></li>
  <li><a href="#æ— ç±»å‹çš„datasetæ“ä½œåˆådataframeæ“ä½œ" id="markdown-toc-æ— ç±»å‹çš„datasetæ“ä½œåˆådataframeæ“ä½œ">æ— ç±»å‹çš„DataSetæ“ä½œï¼ˆåˆåDataFrameæ“ä½œï¼‰</a></li>
  <li><a href="#ä»¥ç¼–ç¨‹æ–¹å¼è¿è¡ŒsqlæŸ¥è¯¢" id="markdown-toc-ä»¥ç¼–ç¨‹æ–¹å¼è¿è¡ŒsqlæŸ¥è¯¢"><strong>ä»¥ç¼–ç¨‹æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢</strong></a></li>
  <li><a href="#å…¨å±€ä¸´æ—¶è§†å›¾" id="markdown-toc-å…¨å±€ä¸´æ—¶è§†å›¾">å…¨å±€ä¸´æ—¶è§†å›¾</a></li>
  <li><a href="#åˆ›å»ºdataset" id="markdown-toc-åˆ›å»ºdataset">åˆ›å»ºDataset</a></li>
  <li><a href="#rddçš„äº’æ“ä½œ" id="markdown-toc-rddçš„äº’æ“ä½œ">RDDçš„äº’æ“ä½œ</a>    <ul>
      <li><a href="#ä½¿ç”¨åå°„æ¨æ–­ç»“æ„" id="markdown-toc-ä½¿ç”¨åå°„æ¨æ–­ç»“æ„">ä½¿ç”¨åå°„æ¨æ–­ç»“æ„</a></li>
      <li><a href="#ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šschemaç»“æ„" id="markdown-toc-ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šschemaç»“æ„">ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šSchemaï¼ˆç»“æ„ï¼‰</a></li>
    </ul>
  </li>
  <li><a href="#æ ‡é‡å‡½æ•°" id="markdown-toc-æ ‡é‡å‡½æ•°">æ ‡é‡å‡½æ•°</a></li>
  <li><a href="#èšåˆ" id="markdown-toc-èšåˆ">èšåˆ</a>    <ul>
      <li><a href="#æœªç±»å‹åŒ–çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°" id="markdown-toc-æœªç±»å‹åŒ–çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°">æœªç±»å‹åŒ–çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°</a></li>
      <li><a href="#ç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°" id="markdown-toc-ç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°">ç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°</a></li>
    </ul>
  </li>
</ul>

<h2 id="èµ·å§‹ç‚¹sparksession">èµ·å§‹ç‚¹ï¼šSparkSession</h2>

<div class="codetabs">
<div data-lang="scala">
    <p><a href="http://spark-cn.cn/api/scala/index.html#org.apache.spark.sql.SparkSession"><code>SparkSession</code></a>ç±»æ˜¯Sparkä¸­æ‰€æœ‰åŠŸèƒ½çš„å…¥å£ç‚¹ã€‚è¦åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„<code>SparkSession</code>ï¼Œåªéœ€ä½¿ç”¨<code>SparkSession.builder()</code>ï¼š</p>
    <div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span>

<span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span>
  <span class="o">.</span><span class="n">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="n">appName</span><span class="o">(</span><span class="s">&quot;Spark SQL basic example&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.some.config.option&quot;</span><span class="o">,</span> <span class="s">&quot;some-value&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>

<span class="c1">// For implicit conversions like converting RDDs to DataFrames</span>
<span class="k">import</span> <span class="nn">spark.implicits._</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <p><a href="http://spark-cn.cn/api/java/index.html#org.apache.spark.sql.SparkSession"><code>SparkSession</code></a>ç±»æ˜¯Sparkä¸­æ‰€æœ‰åŠŸèƒ½çš„å…¥å£ç‚¹ã€‚è¦åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„<code>SparkSession</code>ï¼Œåªéœ€ä½¿ç”¨<code>SparkSession.builder()</code>ï¼š</p>
    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>

<span class="n">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span>
  <span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">appName</span><span class="o">(</span><span class="s">&quot;Java Spark SQL basic example&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">config</span><span class="o">(</span><span class="s">&quot;spark.some.config.option&quot;</span><span class="o">,</span> <span class="s">&quot;some-value&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getOrCreate</span><span class="o">();</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <p><a href="http://spark-cn.cn/api/python/pyspark.sql.html#pyspark.sql.SparkSession"><code>SparkSession</code></a>ç±»æ˜¯Sparkä¸­æ‰€æœ‰åŠŸèƒ½çš„å…¥å£ç‚¹ã€‚è¦åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„<code>SparkSession</code>ï¼Œåªéœ€ä½¿ç”¨<code>SparkSession.builder</code>ï¼š</p>
    <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
    <span class="o">.</span><span class="n">builder</span> \
    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Python Spark SQL basic example&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.some.config.option&quot;</span><span class="p">,</span> <span class="s2">&quot;some-value&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="r">
    <p><a href="http://spark-cn.cn/api/python/pyspark.sql.html#pyspark.sql.SparkSession"><code>SparkSession</code></a>ç±»æ˜¯Sparkä¸­æ‰€æœ‰åŠŸèƒ½çš„å…¥å£ç‚¹ã€‚è¦åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„<code>SparkSession</code>ï¼Œåªéœ€ä½¿ç”¨<code>SparkSession.builder</code>ï¼š</p>

    <div class="highlight"><pre><span></span>sparkR.session<span class="p">(</span>appName <span class="o">=</span> <span class="s">&quot;R Spark SQL basic example&quot;</span><span class="p">,</span> sparkConfig <span class="o">=</span> <span class="kt">list</span><span class="p">(</span>spark.some.config.option <span class="o">=</span> <span class="s">&quot;some-value&quot;</span><span class="p">))</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/r/RSparkSQLExample.R" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

    <p>è¯·æ³¨æ„ï¼Œé¦–æ¬¡è°ƒç”¨æ—¶ï¼Œ<code>sparkR.session()</code>ä¼šåˆå§‹åŒ–å…¨å±€<code>SparkSession</code>å•å®ä¾‹ï¼Œå¹¶å§‹ç»ˆä¸ºè¿ç»­è°ƒç”¨è¿”å›å¯¹æ­¤å®ä¾‹çš„å¼•ç”¨ã€‚è¿™æ ·ï¼Œç”¨æˆ·åªéœ€åˆå§‹åŒ–<code>SparkSession</code>ä¸€æ¬¡ï¼Œç„¶åSparkRä¹‹ç±»çš„å‡½æ•°<code>read.df</code>å°±å¯ä»¥éšå¼è®¿é—®æ­¤å…¨å±€å®ä¾‹ï¼Œå¹¶ä¸”ç”¨æˆ·æ— éœ€ä¼ é€’è¯¥<code>SparkSession</code>å®ä¾‹ã€‚</p>

  </div>
</div>

<p>Spark 2.0ä¸­çš„<code>SparkSession</code>æä¾›äº†å¯¹Hiveçš„å†…ç½®æ”¯æŒï¼ŒåŒ…æ‹¬ä½¿ç”¨HiveQLç¼–å†™æŸ¥è¯¢ï¼Œè®¿é—®Hive UDFä»¥åŠä»Hiveè¡¨è¯»å–æ•°æ®ã€‚è¦ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œä½ ä¸éœ€è¦å®‰è£…Hiveã€‚</p>

<h2 id="åˆ›å»ºdataframe">åˆ›å»ºDataFrame</h2>

<div class="codetabs">
<div data-lang="scala">
    <p>è¦ä½¿ç”¨ <code>SparkSession</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»<a href="sql-getting-started.html#interoperating-with-rdds">ç°æœ‰çš„<code>RDD</code></a>ï¼ŒHiveè¡¨æˆ–<a href="sql-data-sources.html">Sparkæ•°æ®æº</a>åˆ›å»ºDataFrame ã€‚</p>

    <p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹åŸºäºJSONæ–‡ä»¶çš„å†…å®¹åˆ›å»ºä¸€ä¸ªDataFrameï¼š</p>

    <div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.json&quot;</span><span class="o">)</span>

<span class="c1">// Displays the content of the DataFrame to stdout</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <p>è¦ä½¿ç”¨ <code>SparkSession</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»<a href="sql-getting-started.html#interoperating-with-rdds">ç°æœ‰çš„<code>RDD</code></a>ï¼ŒHiveè¡¨æˆ–<a href="sql-data-sources.html">Sparkæ•°æ®æº</a>åˆ›å»ºDataFrame ã€‚</p>

    <p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹åŸºäºJSONæ–‡ä»¶çš„å†…å®¹åˆ›å»ºä¸€ä¸ªDataFrameï¼š</p>

    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">json</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.json&quot;</span><span class="o">);</span>

<span class="c1">// Displays the content of the DataFrame to stdout</span>
<span class="n">df</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <p>è¦ä½¿ç”¨ <code>SparkSession</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»<a href="sql-getting-started.html#interoperating-with-rdds">ç°æœ‰çš„<code>RDD</code></a>ï¼ŒHiveè¡¨æˆ–<a href="sql-data-sources.html">Sparkæ•°æ®æº</a>åˆ›å»ºDataFrame ã€‚</p>

    <p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹åŸºäºJSONæ–‡ä»¶çš„å†…å®¹åˆ›å»ºä¸€ä¸ªDataFrameï¼š</p>

    <div class="highlight"><pre><span></span><span class="c1"># spark is an existing SparkSession</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="s2">&quot;examples/src/main/resources/people.json&quot;</span><span class="p">)</span>
<span class="c1"># Displays the content of the DataFrame to stdout</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># | age|   name|</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># |null|Michael|</span>
<span class="c1"># |  30|   Andy|</span>
<span class="c1"># |  19| Justin|</span>
<span class="c1"># +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="r">
    <p>è¦ä½¿ç”¨ <code>SparkSession</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»<a href="sql-getting-started.html#interoperating-with-rdds">ç°æœ‰çš„<code>RDD</code></a>ï¼ŒHiveè¡¨æˆ–<a href="sql-data-sources.html">Sparkæ•°æ®æº</a>åˆ›å»ºDataFrame ã€‚</p>

    <p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹åŸºäºJSONæ–‡ä»¶çš„å†…å®¹åˆ›å»ºä¸€ä¸ªDataFrameï¼š</p>

    <div class="highlight"><pre><span></span>df <span class="o">&lt;-</span> read.json<span class="p">(</span><span class="s">&quot;examples/src/main/resources/people.json&quot;</span><span class="p">)</span>

<span class="c1"># Displays the content of the DataFrame</span>
<span class="kp">head</span><span class="p">(</span>df<span class="p">)</span>
<span class="c1">##   age    name</span>
<span class="c1">## 1  NA Michael</span>
<span class="c1">## 2  30    Andy</span>
<span class="c1">## 3  19  Justin</span>

<span class="c1"># Another method to print the first few rows and optionally truncate the printing of long values</span>
showDF<span class="p">(</span>df<span class="p">)</span>
<span class="c1">## +----+-------+</span>
<span class="c1">## | age|   name|</span>
<span class="c1">## +----+-------+</span>
<span class="c1">## |null|Michael|</span>
<span class="c1">## |  30|   Andy|</span>
<span class="c1">## |  19| Justin|</span>
<span class="c1">## +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/r/RSparkSQLExample.R" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

  </div>
</div>

<h2 id="æ— ç±»å‹çš„datasetæ“ä½œåˆådataframeæ“ä½œ">æ— ç±»å‹çš„DataSetæ“ä½œï¼ˆåˆåDataFrameæ“ä½œï¼‰</h2>

<p>DataFramesä¸º<a href="api/scala/index.html#org.apache.spark.sql.Dataset">Scala</a>ï¼Œ<a href="api/java/index.html?org/apache/spark/sql/Dataset.html">Java</a>ï¼Œ<a href="api/python/pyspark.sql.html#pyspark.sql.DataFrame">Python</a>å’Œ<a href="api/R/SparkDataFrame.html">Rä¸­çš„</a>ç»“æ„åŒ–æ•°æ®æ“ä½œæä¾›äº†ä¸€ç§domain-specificçš„è¯­è¨€ã€‚</p>

<p>æ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼ŒSpark 2.0 ä¸­DataFrames åœ¨ Scala å’Œ Java API ä¸­ï¼Œä»…ä»…æ˜¯å¤šä¸ª `Row å¯¹è±¡çš„ Datasetã€‚è¿™äº›æ“ä½œä¹Ÿå‚è€ƒäº†ä¸å¼ºç±»å‹çš„ Scala/Java Datasets ä¸­çš„ â€œç±»å‹è½¬æ¢â€ å¯¹åº”çš„ â€œæ— ç±»å‹è½¬æ¢â€ã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬åŒ…æ‹¬ä¸€äº›ä½¿ç”¨æ•°æ®é›†è¿›è¡Œç»“æ„åŒ–æ•°æ®å¤„ç†çš„åŸºæœ¬ç¤ºä¾‹ï¼š</p>

<div class="codetabs">
<div data-lang="scala">
    <div class="highlight"><pre><span></span><span class="c1">// This import is needed to use the $-notation</span>
<span class="k">import</span> <span class="nn">spark.implicits._</span>
<span class="c1">// Print the schema in a tree format</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="o">()</span>
<span class="c1">// root</span>
<span class="c1">// |-- age: long (nullable = true)</span>
<span class="c1">// |-- name: string (nullable = true)</span>

<span class="c1">// Select only the &quot;name&quot; column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +-------+</span>
<span class="c1">// |   name|</span>
<span class="c1">// +-------+</span>
<span class="c1">// |Michael|</span>
<span class="c1">// |   Andy|</span>
<span class="c1">// | Justin|</span>
<span class="c1">// +-------+</span>

<span class="c1">// Select everybody, but increment the age by 1</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;age&quot;</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +-------+---------+</span>
<span class="c1">// |   name|(age + 1)|</span>
<span class="c1">// +-------+---------+</span>
<span class="c1">// |Michael|     null|</span>
<span class="c1">// |   Andy|       31|</span>
<span class="c1">// | Justin|       20|</span>
<span class="c1">// +-------+---------+</span>

<span class="c1">// Select people older than 21</span>
<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;age&quot;</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +---+----+</span>
<span class="c1">// |age|name|</span>
<span class="c1">// +---+----+</span>
<span class="c1">// | 30|Andy|</span>
<span class="c1">// +---+----+</span>

<span class="c1">// Count people by age</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">).</span><span class="n">count</span><span class="o">().</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-----+</span>
<span class="c1">// | age|count|</span>
<span class="c1">// +----+-----+</span>
<span class="c1">// |  19|    1|</span>
<span class="c1">// |null|    1|</span>
<span class="c1">// |  30|    1|</span>
<span class="c1">// +----+-----+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

    <p>æœ‰å…³å¯å¯¹æ•°æ®é›†æ‰§è¡Œçš„æ“ä½œç±»å‹çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="api/scala/index.html#org.apache.spark.sql.Dataset">APIæ–‡æ¡£</a>ã€‚</p>

    <p>é™¤äº†ç®€å•çš„åˆ—å¼•ç”¨å’Œè¡¨è¾¾å¼å¤–ï¼Œæ•°æ®é›†è¿˜å…·æœ‰ä¸°å¯Œçš„å‡½æ•°åº“ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²å¤„ç†ï¼Œæ—¥æœŸè®¡ç®—ï¼Œé€šç”¨æ•°å­¦è¿ç®—ç­‰ã€‚å®Œæ•´åˆ—è¡¨å¯åœ¨<a href="api/scala/index.html#org.apache.spark.sql.functions$">DataFrame Function Referenceä¸­æ‰¾åˆ°</a>ã€‚</p>

  </div>

<div data-lang="java">

    <div class="highlight"><pre><span></span><span class="c1">// col(&quot;...&quot;) is preferable to df.col(&quot;...&quot;)</span>
<span class="kn">import static</span> <span class="nn">org.apache.spark.sql.functions.col</span><span class="o">;</span>

<span class="c1">// Print the schema in a tree format</span>
<span class="n">df</span><span class="o">.</span><span class="na">printSchema</span><span class="o">();</span>
<span class="c1">// root</span>
<span class="c1">// |-- age: long (nullable = true)</span>
<span class="c1">// |-- name: string (nullable = true)</span>

<span class="c1">// Select only the &quot;name&quot; column</span>
<span class="n">df</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +-------+</span>
<span class="c1">// |   name|</span>
<span class="c1">// +-------+</span>
<span class="c1">// |Michael|</span>
<span class="c1">// |   Andy|</span>
<span class="c1">// | Justin|</span>
<span class="c1">// +-------+</span>

<span class="c1">// Select everybody, but increment the age by 1</span>
<span class="n">df</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">),</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">).</span><span class="na">plus</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +-------+---------+</span>
<span class="c1">// |   name|(age + 1)|</span>
<span class="c1">// +-------+---------+</span>
<span class="c1">// |Michael|     null|</span>
<span class="c1">// |   Andy|       31|</span>
<span class="c1">// | Justin|       20|</span>
<span class="c1">// +-------+---------+</span>

<span class="c1">// Select people older than 21</span>
<span class="n">df</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">21</span><span class="o">)).</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +---+----+</span>
<span class="c1">// |age|name|</span>
<span class="c1">// +---+----+</span>
<span class="c1">// | 30|Andy|</span>
<span class="c1">// +---+----+</span>

<span class="c1">// Count people by age</span>
<span class="n">df</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">).</span><span class="na">count</span><span class="o">().</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-----+</span>
<span class="c1">// | age|count|</span>
<span class="c1">// +----+-----+</span>
<span class="c1">// |  19|    1|</span>
<span class="c1">// |null|    1|</span>
<span class="c1">// |  30|    1|</span>
<span class="c1">// +----+-----+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

    <p>æœ‰å…³å¯å¯¹æ•°æ®é›†æ‰§è¡Œçš„æ“ä½œç±»å‹çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="api/java/org/apache/spark/sql/Dataset.html">APIæ–‡æ¡£</a>ã€‚</p>

    <p>é™¤äº†ç®€å•çš„åˆ—å¼•ç”¨å’Œè¡¨è¾¾å¼å¤–ï¼Œæ•°æ®é›†è¿˜å…·æœ‰ä¸°å¯Œçš„å‡½æ•°åº“ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²å¤„ç†ï¼Œæ—¥æœŸè®¡ç®—ï¼Œé€šç”¨æ•°å­¦è¿ç®—ç­‰ã€‚å®Œæ•´åˆ—è¡¨å¯åœ¨<a href="api/java/org/apache/spark/sql/functions.html">DataFrame Function Referenceä¸­æ‰¾åˆ°</a>ã€‚</p>

  </div>

<div data-lang="python">
    <p>åœ¨Pythonä¸­ï¼Œå¯ä»¥é€šè¿‡å±æ€§ï¼ˆ<code>df.age</code>ï¼‰æˆ–é€šè¿‡ç´¢å¼•ï¼ˆ<code>df['age']</code>ï¼‰è®¿é—®DataFrameçš„åˆ—ã€‚å°½ç®¡å‰è€…ä¾¿äºäº¤äº’å¼æ•°æ®æ“ä½œï¼Œä½†å¼ºçƒˆå»ºè®®ç”¨æˆ·ä½¿ç”¨åè€…å½¢å¼ï¼Œè¿™æ ·ä¸ä¼šç ´åDataFrameçš„åˆ—åã€‚</p>

    <div class="highlight"><pre><span></span><span class="c1"># spark, df are from the previous example</span>
<span class="c1"># Print the schema in a tree format</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="c1"># root</span>
<span class="c1"># |-- age: long (nullable = true)</span>
<span class="c1"># |-- name: string (nullable = true)</span>

<span class="c1"># Select only the &quot;name&quot; column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +-------+</span>
<span class="c1"># |   name|</span>
<span class="c1"># +-------+</span>
<span class="c1"># |Michael|</span>
<span class="c1"># |   Andy|</span>
<span class="c1"># | Justin|</span>
<span class="c1"># +-------+</span>

<span class="c1"># Select everybody, but increment the age by 1</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +-------+---------+</span>
<span class="c1"># |   name|(age + 1)|</span>
<span class="c1"># +-------+---------+</span>
<span class="c1"># |Michael|     null|</span>
<span class="c1"># |   Andy|       31|</span>
<span class="c1"># | Justin|       20|</span>
<span class="c1"># +-------+---------+</span>

<span class="c1"># Select people older than 21</span>
<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +---+----+</span>
<span class="c1"># |age|name|</span>
<span class="c1"># +---+----+</span>
<span class="c1"># | 30|Andy|</span>
<span class="c1"># +---+----+</span>

<span class="c1"># Count people by age</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +----+-----+</span>
<span class="c1"># | age|count|</span>
<span class="c1"># +----+-----+</span>
<span class="c1"># |  19|    1|</span>
<span class="c1"># |null|    1|</span>
<span class="c1"># |  30|    1|</span>
<span class="c1"># +----+-----+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
    <p>æœ‰å…³å¯åœ¨DataFrameä¸Šæ‰§è¡Œçš„æ“ä½œç±»å‹çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="api/python/pyspark.sql.html#pyspark.sql.DataFrame">APIæ–‡æ¡£</a>ã€‚</p>

    <p>é™¤äº†ç®€å•çš„åˆ—å¼•ç”¨å’Œè¡¨è¾¾å¼å¤–ï¼ŒDataFramesè¿˜å…·æœ‰ä¸°å¯Œçš„å‡½æ•°åº“ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²å¤„ç†ï¼Œæ—¥æœŸè®¡ç®—ï¼Œå¸¸ç”¨æ•°å­¦è¿ç®—ç­‰ã€‚å®Œæ•´åˆ—è¡¨å¯åœ¨<a href="api/python/pyspark.sql.html#module-pyspark.sql.functions">DataFrame Function Referenceä¸­æ‰¾åˆ°</a>ã€‚</p>

  </div>

<div data-lang="r">

    <div class="highlight"><pre><span></span><span class="c1"># Create the DataFrame</span>
df <span class="o">&lt;-</span> read.json<span class="p">(</span><span class="s">&quot;examples/src/main/resources/people.json&quot;</span><span class="p">)</span>

<span class="c1"># Show the content of the DataFrame</span>
<span class="kp">head</span><span class="p">(</span>df<span class="p">)</span>
<span class="c1">##   age    name</span>
<span class="c1">## 1  NA Michael</span>
<span class="c1">## 2  30    Andy</span>
<span class="c1">## 3  19  Justin</span>


<span class="c1"># Print the schema in a tree format</span>
printSchema<span class="p">(</span>df<span class="p">)</span>
<span class="c1">## root</span>
<span class="c1">## |-- age: long (nullable = true)</span>
<span class="c1">## |-- name: string (nullable = true)</span>

<span class="c1"># Select only the &quot;name&quot; column</span>
<span class="kp">head</span><span class="p">(</span>select<span class="p">(</span>df<span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">))</span>
<span class="c1">##      name</span>
<span class="c1">## 1 Michael</span>
<span class="c1">## 2    Andy</span>
<span class="c1">## 3  Justin</span>

<span class="c1"># Select everybody, but increment the age by 1</span>
<span class="kp">head</span><span class="p">(</span>select<span class="p">(</span>df<span class="p">,</span> df<span class="o">$</span>name<span class="p">,</span> df<span class="o">$</span>age <span class="o">+</span> <span class="m">1</span><span class="p">))</span>
<span class="c1">##      name (age + 1.0)</span>
<span class="c1">## 1 Michael          NA</span>
<span class="c1">## 2    Andy          31</span>
<span class="c1">## 3  Justin          20</span>

<span class="c1"># Select people older than 21</span>
<span class="kp">head</span><span class="p">(</span>where<span class="p">(</span>df<span class="p">,</span> df<span class="o">$</span>age <span class="o">&gt;</span> <span class="m">21</span><span class="p">))</span>
<span class="c1">##   age name</span>
<span class="c1">## 1  30 Andy</span>

<span class="c1"># Count people by age</span>
<span class="kp">head</span><span class="p">(</span>count<span class="p">(</span>groupBy<span class="p">(</span>df<span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">)))</span>
<span class="c1">##   age count</span>
<span class="c1">## 1  19     1</span>
<span class="c1">## 2  NA     1</span>
<span class="c1">## 3  30     1</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/r/RSparkSQLExample.R" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

    <p>æœ‰å…³å¯åœ¨DataFrameä¸Šæ‰§è¡Œçš„æ“ä½œç±»å‹çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="api/python/pyspark.sql.html#pyspark.sql.DataFrame">APIæ–‡æ¡£</a>ã€‚</p>

    <p>é™¤äº†ç®€å•çš„åˆ—å¼•ç”¨å’Œè¡¨è¾¾å¼å¤–ï¼ŒDataFramesè¿˜å…·æœ‰ä¸°å¯Œçš„å‡½æ•°åº“ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²å¤„ç†ï¼Œæ—¥æœŸè®¡ç®—ï¼Œå¸¸ç”¨æ•°å­¦è¿ç®—ç­‰ã€‚å®Œæ•´åˆ—è¡¨å¯åœ¨<a href="api/python/pyspark.sql.html#module-pyspark.sql.functions">DataFrame Function Referenceä¸­æ‰¾åˆ°</a>ã€‚</p>

  </div>

</div>

<h2 id="ä»¥ç¼–ç¨‹æ–¹å¼è¿è¡ŒsqlæŸ¥è¯¢"><strong>ä»¥ç¼–ç¨‹æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢</strong></h2>

<div class="codetabs">
<div data-lang="scala">
    <p><code>SparkSession</code>ä¸­çš„<code>sql</code>å‡½æ•°å¯ä»¥è®©åº”ç”¨ç¨‹åºä»¥ç¼–ç¨‹çš„æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢ï¼Œå¹¶å°†ç»“æœä½œä¸ºä¸€ä¸ª<code>DataFrame</code>è¿”å›ã€‚</p>

    <div class="highlight"><pre><span></span><span class="c1">// Register the DataFrame as a SQL temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">sqlDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM people&quot;</span><span class="o">)</span>
<span class="n">sqlDF</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <p><code>SparkSession</code>ä¸­çš„<code>sql</code>å‡½æ•°å¯ä»¥è®©åº”ç”¨ç¨‹åºä»¥ç¼–ç¨‹çš„æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢ï¼Œå¹¶å°†ç»“æœä½œä¸ºä¸€ä¸ª<code>Dataset&lt;Row&gt;</code>è¿”å›ã€‚</p>

    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>

<span class="c1">// Register the DataFrame as a SQL temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">);</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">sqlDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM people&quot;</span><span class="o">);</span>
<span class="n">sqlDF</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <p><code>SparkSession</code>ä¸­çš„<code>sql</code>å‡½æ•°å¯ä»¥è®©åº”ç”¨ç¨‹åºä»¥ç¼–ç¨‹çš„æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢ï¼Œå¹¶å°†ç»“æœä½œä¸ºä¸€ä¸ª<code>DataFrame</code>è¿”å›ã€‚</p>

    <div class="highlight"><pre><span></span><span class="c1"># Register the DataFrame as a SQL temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;people&quot;</span><span class="p">)</span>

<span class="n">sqlDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM people&quot;</span><span class="p">)</span>
<span class="n">sqlDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># | age|   name|</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># |null|Michael|</span>
<span class="c1"># |  30|   Andy|</span>
<span class="c1"># |  19| Justin|</span>
<span class="c1"># +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="r">
    <p><code>SparkSession</code>ä¸­çš„<code>sql</code>å‡½æ•°å¯ä»¥è®©åº”ç”¨ç¨‹åºä»¥ç¼–ç¨‹çš„æ–¹å¼è¿è¡ŒSQLæŸ¥è¯¢ï¼Œå¹¶å°†ç»“æœä½œä¸ºä¸€ä¸ª<code>SparkDataFrame</code>è¿”å›ã€‚</p>

    <div class="highlight"><pre><span></span>df <span class="o">&lt;-</span> sql<span class="p">(</span><span class="s">&quot;SELECT * FROM table&quot;</span><span class="p">)</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/r/RSparkSQLExample.R" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>

  </div>
</div>

<h2 id="å…¨å±€ä¸´æ—¶è§†å›¾">å…¨å±€ä¸´æ—¶è§†å›¾</h2>

<p>Spark SQLä¸­çš„ä¸´æ—¶è§†å›¾æ˜¯sessionä½œç”¨åŸŸçš„ï¼Œå¦‚æœåˆ›å»ºå®ƒçš„sessionç»ˆæ­¢äº†ï¼Œä¸´æ—¶è¡¨ä¹Ÿå°±æ¶ˆå¤±äº†ã€‚å¦‚æœè¦åœ¨Sparkåº”ç”¨ç¨‹åºç»ˆæ­¢ä¹‹å‰è®©æ‰€æœ‰sessionä¹‹é—´å…±äº«ä¸€ä¸ªä¸´æ—¶è§†å›¾å¹¶ä¿æŒæ´»è·ƒçŠ¶æ€ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨å±€ä¸´æ—¶è§†å›¾ã€‚å…¨å±€ä¸´æ—¶è§†å›¾æ˜¯å’Œç³»ç»Ÿä¿ç•™æ•°æ®åº“<code>global_temp</code>ç»‘å®šçš„ï¼Œæˆ‘ä»¬åœ¨å¼•ç”¨çš„æ—¶å€™å¿…é¡»åŠ ä¸Š<code>global_temp</code>ï¼Œå¦‚ï¼š <code>SELECT * FROM global_temp.view1</code>ã€‚</p>

<div class="codetabs">
<div data-lang="scala">
    <div class="highlight"><pre><span></span><span class="c1">// Register the DataFrame as a global temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="n">createGlobalTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">)</span>

<span class="c1">// Global temporary view is tied to a system preserved database `global_temp`</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM global_temp.people&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>

<span class="c1">// Global temporary view is cross-session</span>
<span class="n">spark</span><span class="o">.</span><span class="n">newSession</span><span class="o">().</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM global_temp.people&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <div class="highlight"><pre><span></span><span class="c1">// Register the DataFrame as a global temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="na">createGlobalTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">);</span>

<span class="c1">// Global temporary view is tied to a system preserved database `global_temp`</span>
<span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM global_temp.people&quot;</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>

<span class="c1">// Global temporary view is cross-session</span>
<span class="n">spark</span><span class="o">.</span><span class="na">newSession</span><span class="o">().</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM global_temp.people&quot;</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <div class="highlight"><pre><span></span><span class="c1"># Register the DataFrame as a global temporary view</span>
<span class="n">df</span><span class="o">.</span><span class="n">createGlobalTempView</span><span class="p">(</span><span class="s2">&quot;people&quot;</span><span class="p">)</span>

<span class="c1"># Global temporary view is tied to a system preserved database `global_temp`</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM global_temp.people&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># | age|   name|</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># |null|Michael|</span>
<span class="c1"># |  30|   Andy|</span>
<span class="c1"># |  19| Justin|</span>
<span class="c1"># +----+-------+</span>

<span class="c1"># Global temporary view is cross-session</span>
<span class="n">spark</span><span class="o">.</span><span class="n">newSession</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM global_temp.people&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># | age|   name|</span>
<span class="c1"># +----+-------+</span>
<span class="c1"># |null|Michael|</span>
<span class="c1"># |  30|   Andy|</span>
<span class="c1"># |  19| Justin|</span>
<span class="c1"># +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="sql">

    <figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">GLOBAL</span> <span class="k">TEMPORARY</span> <span class="k">VIEW</span> <span class="n">temp_view</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">FROM</span> <span class="n">tbl</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">global_temp</span><span class="p">.</span><span class="n">temp_view</span></code></pre></figure>

  </div>
</div>

<h2 id="åˆ›å»ºdataset">åˆ›å»ºDataset</h2>

<p>Datasetä¸RDDç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒä»¬ä¸æ˜¯ä½¿ç”¨Javaåºåˆ—åŒ–æˆ–Kryoï¼Œè€Œæ˜¯ä½¿ç”¨ä¸“ç”¨çš„<a href="api/scala/index.html#org.apache.spark.sql.Encoder">Encoder</a>å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä»¥è¿›è¡Œç½‘ç»œå¤„ç†æˆ–ä¼ è¾“ã€‚è™½ç„¶ç¼–ç å™¨å’Œæ ‡å‡†åºåˆ—åŒ–éƒ½è´Ÿè´£å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚ï¼Œä½†æ˜¯ç¼–ç å™¨æ˜¯åŠ¨æ€ç”Ÿæˆçš„ä»£ç ï¼Œå¹¶ä½¿ç”¨ä¸€ç§æ ¼å¼ï¼Œè¯¥æ ¼å¼å…è®¸Sparkæ‰§è¡Œè®¸å¤šæ“ä½œï¼Œä¾‹å¦‚è¿‡æ»¤ï¼Œæ’åºå’Œå“ˆå¸Œå¤„ç†ï¼Œè€Œæ— éœ€å°†å­—èŠ‚ååºåˆ—åŒ–ä¸ºå¯¹è±¡ã€‚</p>

<div class="codetabs">
<div data-lang="scala">
    <div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="c1">// Encoders are created for case classes</span>
<span class="k">val</span> <span class="n">caseClassDS</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;Andy&quot;</span><span class="o">,</span> <span class="mi">32</span><span class="o">)).</span><span class="n">toDS</span><span class="o">()</span>
<span class="n">caseClassDS</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+---+</span>
<span class="c1">// |name|age|</span>
<span class="c1">// +----+---+</span>
<span class="c1">// |Andy| 32|</span>
<span class="c1">// +----+---+</span>

<span class="c1">// Encoders for most common types are automatically provided by importing spark.implicits._</span>
<span class="k">val</span> <span class="n">primitiveDS</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="n">toDS</span><span class="o">()</span>
<span class="n">primitiveDS</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">collect</span><span class="o">()</span> <span class="c1">// Returns: Array(2, 3, 4)</span>

<span class="c1">// DataFrames can be converted to a Dataset by providing a class. Mapping will be done by name</span>
<span class="k">val</span> <span class="n">path</span> <span class="k">=</span> <span class="s">&quot;examples/src/main/resources/people.json&quot;</span>
<span class="k">val</span> <span class="n">peopleDS</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
<span class="n">peopleDS</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.function.MapFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoders</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Create an instance of a Bean class</span>
<span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">person</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Andy&quot;</span><span class="o">);</span>
<span class="n">person</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>

<span class="c1">// Encoders are created for Java beans</span>
<span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personEncoder</span> <span class="o">=</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">javaBeanDS</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">createDataset</span><span class="o">(</span>
  <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">person</span><span class="o">),</span>
  <span class="n">personEncoder</span>
<span class="o">);</span>
<span class="n">javaBeanDS</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +---+----+</span>
<span class="c1">// |age|name|</span>
<span class="c1">// +---+----+</span>
<span class="c1">// | 32|Andy|</span>
<span class="c1">// +---+----+</span>

<span class="c1">// Encoders for most common types are provided in class Encoders</span>
<span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">integerEncoder</span> <span class="o">=</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">INT</span><span class="o">();</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">primitiveDS</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">createDataset</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="n">integerEncoder</span><span class="o">);</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">transformedDS</span> <span class="o">=</span> <span class="n">primitiveDS</span><span class="o">.</span><span class="na">map</span><span class="o">(</span>
    <span class="o">(</span><span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;)</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
    <span class="n">integerEncoder</span><span class="o">);</span>
<span class="n">transformedDS</span><span class="o">.</span><span class="na">collect</span><span class="o">();</span> <span class="c1">// Returns [2, 3, 4]</span>

<span class="c1">// DataFrames can be converted to a Dataset by providing a class. Mapping based on name</span>
<span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;examples/src/main/resources/people.json&quot;</span><span class="o">;</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">peopleDS</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">json</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">personEncoder</span><span class="o">);</span>
<span class="n">peopleDS</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// | age|   name|</span>
<span class="c1">// +----+-------+</span>
<span class="c1">// |null|Michael|</span>
<span class="c1">// |  30|   Andy|</span>
<span class="c1">// |  19| Justin|</span>
<span class="c1">// +----+-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>
</div>

<h2 id="rddçš„äº’æ“ä½œ">RDDçš„äº’æ“ä½œ</h2>

<p>Spark SQLæ”¯æŒä¸¤ç§å°†ç°æœ‰RDDè½¬æ¢ä¸ºDatasetçš„æ–¹æ³•ã€‚ç¬¬ä¸€ç§æ–¹æ³•ä½¿ç”¨åå°„æ¥æ¨æ–­åŒ…å«ç‰¹å®šå¯¹è±¡ç±»å‹çš„RDDçš„Schemaï¼ˆç»“æ„ï¼‰ã€‚è¿™ç§åŸºäºåå°„çš„æ–¹æ³•å¯ä»¥ä½¿ä»£ç æ›´ç®€æ´ï¼Œå¹¶ä¸”å½“ä½ åœ¨ç¼–å†™Sparkåº”ç”¨ç¨‹åºæ—¶å·²ç»äº†è§£Schemaï¼ˆç»“æ„ï¼‰çš„è¯ï¼Œå¯ä»¥å¾ˆå¥½åœ°å·¥ä½œã€‚</p>

<p>åˆ›å»ºDatasetçš„ç¬¬äºŒç§æ–¹æ³•æ˜¯é€šè¿‡ç¼–ç¨‹æ¥å£ï¼Œè¯¥æ¥å£å…è®¸ä½ æ„é€ ä¸€ä¸ªSchemaï¼ˆç»“æ„ï¼‰ï¼Œç„¶åå°†å…¶åº”ç”¨äºç°æœ‰çš„RDDã€‚å°½ç®¡æ­¤æ–¹æ³•è¾ƒä¸ºå†—é•¿ï¼Œä½†å¯ä»¥è®©ä½ åœ¨è¿è¡Œå‰çŸ¥é“åˆ—åŠå…¶ç±»å‹å¹¶æ„é€ Datasetã€‚</p>

<h3 id="ä½¿ç”¨åå°„æ¨æ–­ç»“æ„">ä½¿ç”¨åå°„æ¨æ–­ç»“æ„</h3>
<div class="codetabs">

<div data-lang="scala">
    <p>Spark SQL çš„ Scala æ¥å£æ”¯æŒè‡ªåŠ¨è½¬æ¢ä¸€ä¸ªåŒ…å« case classes çš„ RDD ä¸º DataFrameã€‚Case class å®šä¹‰äº†è¡¨çš„ Schemaã€‚Case class çš„å‚æ•°åä½¿ç”¨åå°„è¯»å–å¹¶ä¸”æˆä¸ºäº†åˆ—åã€‚Case class ä¹Ÿå¯ä»¥æ˜¯åµŒå¥—çš„æˆ–è€…åŒ…å«åƒ <code>Seq</code> æˆ–è€… <code>Array</code> è¿™æ ·çš„å¤æ‚ç±»å‹ã€‚è¿™ä¸ª RDD èƒ½å¤Ÿè¢«éšå¼è½¬æ¢æˆä¸€ä¸ª DataFrame ç„¶åè¢«æ³¨å†Œä¸ºä¸€ä¸ªè¡¨ã€‚è¡¨å¯ä»¥ç”¨äºåç»­çš„ SQL è¯­å¥ã€‚</p>

    <div class="highlight"><pre><span></span><span class="c1">// For implicit conversions from RDDs to DataFrames</span>
<span class="k">import</span> <span class="nn">spark.implicits._</span>

<span class="c1">// Create an RDD of Person objects from a text file, convert it to a Dataframe</span>
<span class="k">val</span> <span class="n">peopleDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
  <span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.txt&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">attributes</span> <span class="k">=&gt;</span> <span class="nc">Person</span><span class="o">(</span><span class="n">attributes</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">attributes</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">trim</span><span class="o">.</span><span class="n">toInt</span><span class="o">))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="o">()</span>
<span class="c1">// Register the DataFrame as a temporary view</span>
<span class="n">peopleDF</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">)</span>

<span class="c1">// SQL statements can be run by using the sql methods provided by Spark</span>
<span class="k">val</span> <span class="n">teenagersDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT name, age FROM people WHERE age BETWEEN 13 AND 19&quot;</span><span class="o">)</span>

<span class="c1">// The columns of a row in the result can be accessed by field index</span>
<span class="n">teenagersDF</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">teenager</span> <span class="k">=&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">teenager</span><span class="o">(</span><span class="mi">0</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +------------+</span>
<span class="c1">// |       value|</span>
<span class="c1">// +------------+</span>
<span class="c1">// |Name: Justin|</span>
<span class="c1">// +------------+</span>

<span class="c1">// or by field name</span>
<span class="n">teenagersDF</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">teenager</span> <span class="k">=&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">teenager</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;name&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +------------+</span>
<span class="c1">// |       value|</span>
<span class="c1">// +------------+</span>
<span class="c1">// |Name: Justin|</span>
<span class="c1">// +------------+</span>

<span class="c1">// No pre-defined encoders for Dataset[Map[K,V]], define explicitly</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">mapEncoder</span> <span class="k">=</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="nc">Encoders</span><span class="o">.</span><span class="n">kryo</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]]</span>
<span class="c1">// Primitive types and case classes can be also defined as</span>
<span class="c1">// implicit val stringIntMapEncoder: Encoder[Map[String, Any]] = ExpressionEncoder()</span>

<span class="c1">// row.getValuesMap[T] retrieves multiple columns at once into a Map[String, T]</span>
<span class="n">teenagersDF</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">teenager</span> <span class="k">=&gt;</span> <span class="n">teenager</span><span class="o">.</span><span class="n">getValuesMap</span><span class="o">[</span><span class="kt">Any</span><span class="o">](</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="o">))).</span><span class="n">collect</span><span class="o">()</span>
<span class="c1">// Array(Map(&quot;name&quot; -&gt; &quot;Justin&quot;, &quot;age&quot; -&gt; 19))</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <p>Spark SQLæ”¯æŒå°†<a href="http://stackoverflow.com/questions/3295496/what-is-a-javabean-exactly">JavaBean</a>çš„RDDè‡ªåŠ¨è½¬æ¢ä¸ºDataFrameã€‚<code>BeanInfo</code>é€šè¿‡åå°„åˆ›å»ºå¹¶å®šä¹‰äº†è¡¨çš„ç»“æ„ï¼ˆSchemaï¼‰ã€‚å½“å‰ï¼ŒSpark SQLä¸æ”¯æŒåŒ…å«<code>Map</code>çš„JavaBean ã€‚ ä¸è¿‡æ”¯æŒåµŒå¥—JavaBeanå’Œ<code>List</code>æˆ–<code>Array</code>ã€‚ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªå®ç°Serializableï¼Œå¹¶å…·æœ‰å…¶æ‰€æœ‰å­—æ®µgetterå’Œsetteræ–¹æ³•çš„ç±»æ¥åˆ›å»ºJavaBeanã€‚</p>

    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.spark.api.java.JavaRDD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.function.Function</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.function.MapFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoders</span><span class="o">;</span>

<span class="c1">// Create an RDD of Person objects from a text file</span>
<span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">peopleRDD</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">()</span>
  <span class="o">.</span><span class="na">textFile</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.txt&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">javaRDD</span><span class="o">()</span>
  <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
    <span class="n">person</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="n">person</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">trim</span><span class="o">()));</span>
    <span class="k">return</span> <span class="n">person</span><span class="o">;</span>
  <span class="o">});</span>

<span class="c1">// Apply a schema to an RDD of JavaBeans to get a DataFrame</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">peopleDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">createDataFrame</span><span class="o">(</span><span class="n">peopleRDD</span><span class="o">,</span> <span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// Register the DataFrame as a temporary view</span>
<span class="n">peopleDF</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">);</span>

<span class="c1">// SQL statements can be run by using the sql methods provided by spark</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">teenagersDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT name FROM people WHERE age BETWEEN 13 AND 19&quot;</span><span class="o">);</span>

<span class="c1">// The columns of a row in the result can be accessed by field index</span>
<span class="n">Encoder</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stringEncoder</span> <span class="o">=</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">STRING</span><span class="o">();</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">teenagerNamesByIndexDF</span> <span class="o">=</span> <span class="n">teenagersDF</span><span class="o">.</span><span class="na">map</span><span class="o">(</span>
    <span class="o">(</span><span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;)</span> <span class="n">row</span> <span class="o">-&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
    <span class="n">stringEncoder</span><span class="o">);</span>
<span class="n">teenagerNamesByIndexDF</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +------------+</span>
<span class="c1">// |       value|</span>
<span class="c1">// +------------+</span>
<span class="c1">// |Name: Justin|</span>
<span class="c1">// +------------+</span>

<span class="c1">// or by field name</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">teenagerNamesByFieldDF</span> <span class="o">=</span> <span class="n">teenagersDF</span><span class="o">.</span><span class="na">map</span><span class="o">(</span>
    <span class="o">(</span><span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;)</span> <span class="n">row</span> <span class="o">-&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="n">getAs</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">),</span>
    <span class="n">stringEncoder</span><span class="o">);</span>
<span class="n">teenagerNamesByFieldDF</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +------------+</span>
<span class="c1">// |       value|</span>
<span class="c1">// +------------+</span>
<span class="c1">// |Name: Justin|</span>
<span class="c1">// +------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <p>Spark SQLå¯ä»¥å°†Rowå¯¹è±¡çš„RDDè½¬æ¢ä¸ºDataFrameï¼Œä»è€Œæ¨æ–­æ•°æ®ç±»å‹ã€‚é€šè¿‡å°†key/valueå¯¹çš„listä½œä¸ºkwargsä¼ é€’ç»™Rowç±»æ¥æ„é€ Rowå¯¹è±¡ã€‚keyå®šä¹‰è¡¨çš„åˆ—åï¼Œå¹¶ä¸”é€šè¿‡å¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œé‡‡æ ·æ¥æ¨æ–­ç±»å‹ï¼Œç±»ä¼¼äºå¯¹JSONæ–‡ä»¶æ‰§è¡Œçš„æ¨æ–­ã€‚</p>

    <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>

<span class="c1"># Load a text file and convert each line to a Row.</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="s2">&quot;examples/src/main/resources/people.txt&quot;</span><span class="p">)</span>
<span class="n">parts</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">Row</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">age</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="c1"># Infer the schema, and register the DataFrame as a table.</span>
<span class="n">schemaPeople</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">people</span><span class="p">)</span>
<span class="n">schemaPeople</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;people&quot;</span><span class="p">)</span>

<span class="c1"># SQL can be run over DataFrames that have been registered as a table.</span>
<span class="n">teenagers</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM people WHERE age &gt;= 13 AND age &lt;= 19&quot;</span><span class="p">)</span>

<span class="c1"># The results of SQL queries are Dataframe objects.</span>
<span class="c1"># rdd returns the content as an :class:`pyspark.RDD` of :class:`Row`.</span>
<span class="n">teenNames</span> <span class="o">=</span> <span class="n">teenagers</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="s2">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">teenNames</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="c1"># Name: Justin</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

</div>

<h3 id="ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šschemaç»“æ„">ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šSchemaï¼ˆç»“æ„ï¼‰</h3>

<div class="codetabs">

<div data-lang="scala">
    <p>å¦‚æœ case class ä¸èƒ½å¤Ÿåœ¨æ‰§è¡Œä¹‹å‰è¢«å®šä¹‰ï¼ˆä¾‹å¦‚ï¼Œrecords è®°å½•çš„ç»“æ„åœ¨ä¸€ä¸ª string å­—ç¬¦ä¸²ä¸­è¢«ç¼–ç äº†ï¼Œæˆ–è€…ä¸€ä¸ª text æ–‡æœ¬ dataset ä¸ºä¸åŒç”¨æˆ·è§£æçš„ç»“æœä¸ä¸€æ ·ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰æ­¥åˆ›å»º<code>DataFrame</code>ï¼š</p>

    <ol>
      <li>ä»åŸå§‹RDDåˆ›å»º <code>Row</code>  ç»„æˆçš„RDDï¼›</li>
      <li>åˆ›å»ºä¸€ä¸ªåŒ¹é…äº†ç”¨<code>StructType</code> è¡¨ç¤ºçš„schemaï¼Œ<code>StructType</code>å’Œåœ¨æ­¥éª¤1ä¸­åˆ›å»ºçš„RDDçš„<code>Row</code>ç›¸åŒ¹é…ã€‚</li>
      <li>é€šè¿‡ <code>SparkSession</code> æä¾›çš„ <code>createDataFrame</code> æ–¹æ³•å°† Schema åº”ç”¨åˆ° RDD çš„ RowSï¼ˆè¡Œï¼‰ã€‚</li>
    </ol>

    <p>å¦‚ï¼š</p>

    <div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>

<span class="c1">// Create an RDD</span>
<span class="k">val</span> <span class="n">peopleRDD</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.txt&quot;</span><span class="o">)</span>

<span class="c1">// The schema is encoded in a string</span>
<span class="k">val</span> <span class="n">schemaString</span> <span class="k">=</span> <span class="s">&quot;name age&quot;</span>

<span class="c1">// Generate the schema based on the string of schema</span>
<span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">schemaString</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">fieldName</span> <span class="k">=&gt;</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">nullable</span> <span class="k">=</span> <span class="kc">true</span><span class="o">))</span>
<span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="n">fields</span><span class="o">)</span>

<span class="c1">// Convert records of the RDD (people) to Rows</span>
<span class="k">val</span> <span class="n">rowRDD</span> <span class="k">=</span> <span class="n">peopleRDD</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">attributes</span> <span class="k">=&gt;</span> <span class="nc">Row</span><span class="o">(</span><span class="n">attributes</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">attributes</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">trim</span><span class="o">))</span>

<span class="c1">// Apply the schema to the RDD</span>
<span class="k">val</span> <span class="n">peopleDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="o">(</span><span class="n">rowRDD</span><span class="o">,</span> <span class="n">schema</span><span class="o">)</span>

<span class="c1">// Creates a temporary view using the DataFrame</span>
<span class="n">peopleDF</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">)</span>

<span class="c1">// SQL can be run over a temporary view created using DataFrames</span>
<span class="k">val</span> <span class="n">results</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT name FROM people&quot;</span><span class="o">)</span>

<span class="c1">// The results of SQL queries are DataFrames and support all the normal RDD operations</span>
<span class="c1">// The columns of a row in the result can be accessed by field index or by field name</span>
<span class="n">results</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">attributes</span> <span class="k">=&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">attributes</span><span class="o">(</span><span class="mi">0</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +-------------+</span>
<span class="c1">// |        value|</span>
<span class="c1">// +-------------+</span>
<span class="c1">// |Name: Michael|</span>
<span class="c1">// |   Name: Andy|</span>
<span class="c1">// | Name: Justin|</span>
<span class="c1">// +-------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/SparkSQLExample.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="java">
    <p>å½“æ— æ³•æå‰å®šä¹‰JavaBeanç±»æ—¶ï¼ˆä¾‹å¦‚ï¼Œrecords è®°å½•çš„ç»“æ„åœ¨ä¸€ä¸ª string å­—ç¬¦ä¸²ä¸­è¢«ç¼–ç äº†ï¼Œæˆ–è€…ä¸€ä¸ª text æ–‡æœ¬ dataset ä¸ºä¸åŒç”¨æˆ·è§£æçš„ç»“æœä¸ä¸€æ ·ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰æ­¥åˆ›å»º <code>Dataset&lt;Row&gt;</code> ï¼š</p>

    <ol>
      <li>ä»åŸå§‹RDDåˆ›å»º <code>Row</code>  ç»„æˆçš„RDDï¼›</li>
      <li>åˆ›å»ºä¸€ä¸ªåŒ¹é…äº†ç”¨<code>StructType</code> è¡¨ç¤ºçš„schemaï¼Œ<code>StructType</code>å’Œåœ¨æ­¥éª¤1ä¸­åˆ›å»ºçš„RDDçš„<code>Row</code>ç›¸åŒ¹é…ã€‚</li>
      <li>é€šè¿‡ <code>SparkSession</code> æä¾›çš„ <code>createDataFrame</code> æ–¹æ³•å°† Schema åº”ç”¨åˆ° RDD çš„ RowSï¼ˆè¡Œï¼‰ã€‚</li>
    </ol>

    <p>å¦‚ï¼š</p>

    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.JavaRDD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.function.Function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.DataTypes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructField</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructType</span><span class="o">;</span>

<span class="c1">// Create an RDD</span>
<span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">peopleRDD</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sparkContext</span><span class="o">()</span>
  <span class="o">.</span><span class="na">textFile</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/people.txt&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
  <span class="o">.</span><span class="na">toJavaRDD</span><span class="o">();</span>

<span class="c1">// The schema is encoded in a string</span>
<span class="n">String</span> <span class="n">schemaString</span> <span class="o">=</span> <span class="s">&quot;name age&quot;</span><span class="o">;</span>

<span class="c1">// Generate the schema based on the string of schema</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">StructField</span><span class="o">&gt;</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">fieldName</span> <span class="o">:</span> <span class="n">schemaString</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">))</span> <span class="o">{</span>
  <span class="n">StructField</span> <span class="n">field</span> <span class="o">=</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">,</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="n">fields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">StructType</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructType</span><span class="o">(</span><span class="n">fields</span><span class="o">);</span>

<span class="c1">// Convert records of the RDD (people) to Rows</span>
<span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">rowRDD</span> <span class="o">=</span> <span class="n">peopleRDD</span><span class="o">.</span><span class="na">map</span><span class="o">((</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Row</span><span class="o">&gt;)</span> <span class="n">record</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="n">String</span><span class="o">[]</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">attributes</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">attributes</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">trim</span><span class="o">());</span>
<span class="o">});</span>

<span class="c1">// Apply the schema to the RDD</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">peopleDataFrame</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">createDataFrame</span><span class="o">(</span><span class="n">rowRDD</span><span class="o">,</span> <span class="n">schema</span><span class="o">);</span>

<span class="c1">// Creates a temporary view using the DataFrame</span>
<span class="n">peopleDataFrame</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;people&quot;</span><span class="o">);</span>

<span class="c1">// SQL can be run over a temporary view created using DataFrames</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT name FROM people&quot;</span><span class="o">);</span>

<span class="c1">// The results of SQL queries are DataFrames and support all the normal RDD operations</span>
<span class="c1">// The columns of a row in the result can be accessed by field index or by field name</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">namesDS</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="na">map</span><span class="o">(</span>
    <span class="o">(</span><span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;)</span> <span class="n">row</span> <span class="o">-&gt;</span> <span class="s">&quot;Name: &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
    <span class="n">Encoders</span><span class="o">.</span><span class="na">STRING</span><span class="o">());</span>
<span class="n">namesDS</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +-------------+</span>
<span class="c1">// |        value|</span>
<span class="c1">// +-------------+</span>
<span class="c1">// |Name: Michael|</span>
<span class="c1">// |   Name: Andy|</span>
<span class="c1">// | Name: Justin|</span>
<span class="c1">// +-------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaSparkSQLExample.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

<div data-lang="python">
    <p>å½“æ— æ³•æå‰å®šä¹‰å­—å…¸çš„kwargs æ—¶ï¼ˆä¾‹å¦‚ï¼Œrecords è®°å½•çš„ç»“æ„åœ¨ä¸€ä¸ª string å­—ç¬¦ä¸²ä¸­è¢«ç¼–ç äº†ï¼Œæˆ–è€…ä¸€ä¸ª text æ–‡æœ¬ dataset ä¸ºä¸åŒç”¨æˆ·è§£æçš„ç»“æœä¸ä¸€æ ·ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰æ­¥åˆ›å»º <code>Dataset&lt;Row&gt;</code> ï¼š</p>

    <ol>
      <li>ä»åŸå§‹RDDåˆ›å»º <code>Row</code>  ç»„æˆçš„RDDï¼›</li>
      <li>åˆ›å»ºä¸€ä¸ªåŒ¹é…äº†ç”¨<code>StructType</code> è¡¨ç¤ºçš„schemaï¼Œ<code>StructType</code>å’Œåœ¨æ­¥éª¤1ä¸­åˆ›å»ºçš„RDDçš„<code>Row</code>ç›¸åŒ¹é…ã€‚</li>
      <li>é€šè¿‡ <code>SparkSession</code> æä¾›çš„ <code>createDataFrame</code> æ–¹æ³•å°† Schema åº”ç”¨åˆ° RDD çš„ RowSï¼ˆè¡Œï¼‰ã€‚</li>
    </ol>

    <p>å¦‚ï¼š</p>

    <div class="highlight"><pre><span></span><span class="c1"># Import data types</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>

<span class="c1"># Load a text file and convert each line to a Row.</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="s2">&quot;examples/src/main/resources/people.txt&quot;</span><span class="p">)</span>
<span class="n">parts</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
<span class="c1"># Each line is converted to a tuple.</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

<span class="c1"># The schema is encoded in a string.</span>
<span class="n">schemaString</span> <span class="o">=</span> <span class="s2">&quot;name age&quot;</span>

<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">schemaString</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

<span class="c1"># Apply the schema to the RDD.</span>
<span class="n">schemaPeople</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

<span class="c1"># Creates a temporary view using the DataFrame</span>
<span class="n">schemaPeople</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;people&quot;</span><span class="p">)</span>

<span class="c1"># SQL can be run over DataFrames that have been registered as a table.</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM people&quot;</span><span class="p">)</span>

<span class="n">results</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># +-------+</span>
<span class="c1"># |   name|</span>
<span class="c1"># +-------+</span>
<span class="c1"># |Michael|</span>
<span class="c1"># |   Andy|</span>
<span class="c1"># | Justin|</span>
<span class="c1"># +-------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/python/sql/basic.py" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>

</div>

<h2 id="æ ‡é‡å‡½æ•°">æ ‡é‡å‡½æ•°</h2>
<p>(to be filled soon)</p>

<h2 id="èšåˆ">èšåˆ</h2>

<p>Sparkæä¾›äº†ä¸€äº› <a href="api/scala/index.html#org.apache.spark.sql.functions$">å†…ç½®çš„ DataFrames å‡½æ•°</a> å¦‚ <code>count()</code>, <code>countDistinct()</code>, <code>avg()</code>, <code>max()</code>, `min()
ç­‰ã€‚è™½ç„¶è¿™äº›å‡½æ•°æ˜¯ä¸ºDataFrameè®¾è®¡çš„ï¼Œä½†Spark SQLåœ¨<a href="api/scala/index.html#org.apache.spark.sql.expressions.scalalang.typed$">Scala</a>å’Œ<a href="api/java/org/apache/spark/sql/expressions/javalang/typed.html">Java</a>ä¸­ä¹Ÿæä¾›äº†è¿™äº›å‡½æ•°type-safeçš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿å…¶é€šè¿‡å¼ºç±»å‹çš„Datasetå·¥ä½œã€‚æ­¤å¤–ï¼Œé™¤äº†å†…ç½®çš„å‡½æ•°ï¼Œç”¨æˆ·è¿˜å¯ä»¥è‡ªå®šä¹‰ç›¸å…³å‡½æ•°ã€‚</p>

<h3 id="æœªç±»å‹åŒ–çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°">æœªç±»å‹åŒ–çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°</h3>

<p>ç”¨æˆ·å¿…é¡»ç»§æ‰¿<a href="api/scala/index.html#org.apache.spark.sql.expressions.UserDefinedAggregateFunction">UserDefinedAggregateFunction</a> æŠ½è±¡ç±»ä»¥å®ç°è‡ªå®šä¹‰æ— ç±»å‹çš„èšåˆå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å®šä¹‰çš„å¹³å‡å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="codetabs">
<div data-lang="scala">
    <div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.</span><span class="o">{</span><span class="nc">Row</span><span class="o">,</span> <span class="nc">SparkSession</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.MutableAggregationBuffer</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.UserDefinedAggregateFunction</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>

<span class="k">object</span> <span class="nc">MyAverage</span> <span class="k">extends</span> <span class="nc">UserDefinedAggregateFunction</span> <span class="o">{</span>
  <span class="c1">// Data types of input arguments of this aggregate function</span>
  <span class="k">def</span> <span class="n">inputSchema</span><span class="k">:</span> <span class="kt">StructType</span> <span class="o">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;inputColumn&quot;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
  <span class="c1">// Data types of values in the aggregation buffer</span>
  <span class="k">def</span> <span class="n">bufferSchema</span><span class="k">:</span> <span class="kt">StructType</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;sum&quot;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="c1">// The data type of the returned value</span>
  <span class="k">def</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">DataType</span> <span class="o">=</span> <span class="nc">DoubleType</span>
  <span class="c1">// Whether this function always returns the same output on the identical input</span>
  <span class="k">def</span> <span class="n">deterministic</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="c1">// Initializes the given aggregation buffer. The buffer itself is a `Row` that in addition to</span>
  <span class="c1">// standard methods like retrieving a value at an index (e.g., get(), getBoolean()), provides</span>
  <span class="c1">// the opportunity to update its values. Note that arrays and maps inside the buffer are still</span>
  <span class="c1">// immutable.</span>
  <span class="k">def</span> <span class="n">initialize</span><span class="o">(</span><span class="n">buffer</span><span class="k">:</span> <span class="kt">MutableAggregationBuffer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">buffer</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">=</span> <span class="mi">0L</span>
    <span class="n">buffer</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="k">=</span> <span class="mi">0L</span>
  <span class="o">}</span>
  <span class="c1">// Updates the given aggregation buffer `buffer` with new input data from `input`</span>
  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">buffer</span><span class="k">:</span> <span class="kt">MutableAggregationBuffer</span><span class="o">,</span> <span class="n">input</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">input</span><span class="o">.</span><span class="n">isNullAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">buffer</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">input</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
      <span class="n">buffer</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="k">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// Merges two aggregation buffers and stores the updated buffer values back to `buffer1`</span>
  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">buffer1</span><span class="k">:</span> <span class="kt">MutableAggregationBuffer</span><span class="o">,</span> <span class="n">buffer2</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">buffer1</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">=</span> <span class="n">buffer1</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="n">buffer1</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="k">=</span> <span class="n">buffer1</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="c1">// Calculates the final result</span>
  <span class="k">def</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">buffer</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toDouble</span> <span class="o">/</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// Register the function to access it</span>
<span class="n">spark</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="o">(</span><span class="s">&quot;myAverage&quot;</span><span class="o">,</span> <span class="nc">MyAverage</span><span class="o">)</span>

<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;employees&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT myAverage(salary) as average_salary FROM employees&quot;</span><span class="o">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/UserDefinedUntypedAggregation.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>
<div data-lang="java">
    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.MutableAggregationBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.UserDefinedAggregateFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.DataType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.DataTypes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructField</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructType</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyAverage</span> <span class="kd">extends</span> <span class="n">UserDefinedAggregateFunction</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">StructType</span> <span class="n">inputSchema</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">StructType</span> <span class="n">bufferSchema</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MyAverage</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">StructField</span><span class="o">&gt;</span> <span class="n">inputFields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">inputFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructField</span><span class="o">(</span><span class="s">&quot;inputColumn&quot;</span><span class="o">,</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">LongType</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">inputSchema</span> <span class="o">=</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructType</span><span class="o">(</span><span class="n">inputFields</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">StructField</span><span class="o">&gt;</span> <span class="n">bufferFields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">bufferFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructField</span><span class="o">(</span><span class="s">&quot;sum&quot;</span><span class="o">,</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">LongType</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">bufferFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructField</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">LongType</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">bufferSchema</span> <span class="o">=</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">createStructType</span><span class="o">(</span><span class="n">bufferFields</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// Data types of input arguments of this aggregate function</span>
  <span class="kd">public</span> <span class="n">StructType</span> <span class="nf">inputSchema</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">inputSchema</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Data types of values in the aggregation buffer</span>
  <span class="kd">public</span> <span class="n">StructType</span> <span class="nf">bufferSchema</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">bufferSchema</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// The data type of the returned value</span>
  <span class="kd">public</span> <span class="n">DataType</span> <span class="nf">dataType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">DoubleType</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Whether this function always returns the same output on the identical input</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">deterministic</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Initializes the given aggregation buffer. The buffer itself is a `Row` that in addition to</span>
  <span class="c1">// standard methods like retrieving a value at an index (e.g., get(), getBoolean()), provides</span>
  <span class="c1">// the opportunity to update its values. Note that arrays and maps inside the buffer are still</span>
  <span class="c1">// immutable.</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">MutableAggregationBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="n">L</span><span class="o">);</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="n">L</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// Updates the given aggregation buffer `buffer` with new input data from `input`</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">MutableAggregationBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">Row</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">input</span><span class="o">.</span><span class="na">isNullAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
      <span class="kt">long</span> <span class="n">updatedSum</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">input</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="kt">long</span> <span class="n">updatedCount</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">updatedSum</span><span class="o">);</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">updatedCount</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// Merges two aggregation buffers and stores the updated buffer values back to `buffer1`</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="n">MutableAggregationBuffer</span> <span class="n">buffer1</span><span class="o">,</span> <span class="n">Row</span> <span class="n">buffer2</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">mergedSum</span> <span class="o">=</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">mergedCount</span> <span class="o">=</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">buffer1</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">mergedSum</span><span class="o">);</span>
    <span class="n">buffer1</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">mergedCount</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// Calculates the final result</span>
  <span class="kd">public</span> <span class="n">Double</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">Row</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">/</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Register the function to access it</span>
<span class="n">spark</span><span class="o">.</span><span class="na">udf</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;myAverage&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyAverage</span><span class="o">());</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">json</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="o">);</span>
<span class="n">df</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;employees&quot;</span><span class="o">);</span>
<span class="n">df</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&quot;SELECT myAverage(salary) as average_salary FROM employees&quot;</span><span class="o">);</span>
<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaUserDefinedUntypedAggregation.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>
</div>

<h3 id="ç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°">ç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°</h3>

<p>ç”¨æˆ·å®šä¹‰çš„å¼ºç±»å‹Datasetçš„<a href="api/scala/index.html#org.apache.spark.sql.expressions.Aggregator">èšåˆ</a>å›´ç»•<a href="api/scala/index.html#org.apache.spark.sql.expressions.Aggregator">Aggregator</a>æŠ½è±¡ç±»å±•å¼€ã€‚ä¾‹å¦‚ï¼Œç±»å‹å®‰å…¨çš„ç”¨æˆ·å®šä¹‰çš„å¹³å‡å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="codetabs">
<div data-lang="scala">
    <div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.</span><span class="o">{</span><span class="nc">Encoder</span><span class="o">,</span> <span class="nc">Encoders</span><span class="o">,</span> <span class="nc">SparkSession</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Aggregator</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Employee</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">salary</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Average</span><span class="o">(</span><span class="k">var</span> <span class="n">sum</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="k">var</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">MyAverage</span> <span class="k">extends</span> <span class="nc">Aggregator</span><span class="o">[</span><span class="kt">Employee</span>, <span class="kt">Average</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>
  <span class="c1">// A zero value for this aggregation. Should satisfy the property that any b + zero = b</span>
  <span class="k">def</span> <span class="n">zero</span><span class="k">:</span> <span class="kt">Average</span> <span class="o">=</span> <span class="nc">Average</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">)</span>
  <span class="c1">// Combine two values to produce a new value. For performance, the function may modify `buffer`</span>
  <span class="c1">// and return it instead of constructing a new object</span>
  <span class="k">def</span> <span class="n">reduce</span><span class="o">(</span><span class="n">buffer</span><span class="k">:</span> <span class="kt">Average</span><span class="o">,</span> <span class="n">employee</span><span class="k">:</span> <span class="kt">Employee</span><span class="o">)</span><span class="k">:</span> <span class="kt">Average</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">employee</span><span class="o">.</span><span class="n">salary</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">buffer</span>
  <span class="o">}</span>
  <span class="c1">// Merge two intermediate values</span>
  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">b1</span><span class="k">:</span> <span class="kt">Average</span><span class="o">,</span> <span class="n">b2</span><span class="k">:</span> <span class="kt">Average</span><span class="o">)</span><span class="k">:</span> <span class="kt">Average</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">b1</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">b2</span><span class="o">.</span><span class="n">sum</span>
    <span class="n">b1</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">b2</span><span class="o">.</span><span class="n">count</span>
    <span class="n">b1</span>
  <span class="o">}</span>
  <span class="c1">// Transform the output of the reduction</span>
  <span class="k">def</span> <span class="n">finish</span><span class="o">(</span><span class="n">reduction</span><span class="k">:</span> <span class="kt">Average</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="n">reduction</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">toDouble</span> <span class="o">/</span> <span class="n">reduction</span><span class="o">.</span><span class="n">count</span>
  <span class="c1">// Specifies the Encoder for the intermediate value type</span>
  <span class="k">def</span> <span class="n">bufferEncoder</span><span class="k">:</span> <span class="kt">Encoder</span><span class="o">[</span><span class="kt">Average</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Encoders</span><span class="o">.</span><span class="n">product</span>
  <span class="c1">// Specifies the Encoder for the final output value type</span>
  <span class="k">def</span> <span class="n">outputEncoder</span><span class="k">:</span> <span class="kt">Encoder</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Encoders</span><span class="o">.</span><span class="n">scalaDouble</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">ds</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">Employee</span><span class="o">]</span>
<span class="n">ds</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="c1">// Convert the function to a `TypedColumn` and give it a name</span>
<span class="k">val</span> <span class="n">averageSalary</span> <span class="k">=</span> <span class="nc">MyAverage</span><span class="o">.</span><span class="n">toColumn</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;average_salary&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">averageSalary</span><span class="o">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/scala/org/apache/spark/examples/sql/UserDefinedTypedAggregation.scala" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>
<div data-lang="java">
    <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.TypedColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.Aggregator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">salary</span><span class="o">;</span>

  <span class="c1">// Constructors, getters, setters...</span>

<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Average</span> <span class="kd">implements</span> <span class="n">Serializable</span>  <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">sum</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">count</span><span class="o">;</span>

  <span class="c1">// Constructors, getters, setters...</span>

<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyAverage</span> <span class="kd">extends</span> <span class="n">Aggregator</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">,</span> <span class="n">Average</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// A zero value for this aggregation. Should satisfy the property that any b + zero = b</span>
  <span class="kd">public</span> <span class="n">Average</span> <span class="nf">zero</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Average</span><span class="o">(</span><span class="mi">0</span><span class="n">L</span><span class="o">,</span> <span class="mi">0</span><span class="n">L</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// Combine two values to produce a new value. For performance, the function may modify `buffer`</span>
  <span class="c1">// and return it instead of constructing a new object</span>
  <span class="kd">public</span> <span class="n">Average</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Average</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">Employee</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">newSum</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getSum</span><span class="o">()</span> <span class="o">+</span> <span class="n">employee</span><span class="o">.</span><span class="na">getSalary</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">newCount</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">setSum</span><span class="o">(</span><span class="n">newSum</span><span class="o">);</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">setCount</span><span class="o">(</span><span class="n">newCount</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Merge two intermediate values</span>
  <span class="kd">public</span> <span class="n">Average</span> <span class="nf">merge</span><span class="o">(</span><span class="n">Average</span> <span class="n">b1</span><span class="o">,</span> <span class="n">Average</span> <span class="n">b2</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">mergedSum</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="na">getSum</span><span class="o">()</span> <span class="o">+</span> <span class="n">b2</span><span class="o">.</span><span class="na">getSum</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">mergedCount</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="n">b2</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
    <span class="n">b1</span><span class="o">.</span><span class="na">setSum</span><span class="o">(</span><span class="n">mergedSum</span><span class="o">);</span>
    <span class="n">b1</span><span class="o">.</span><span class="na">setCount</span><span class="o">(</span><span class="n">mergedCount</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">b1</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Transform the output of the reduction</span>
  <span class="kd">public</span> <span class="n">Double</span> <span class="nf">finish</span><span class="o">(</span><span class="n">Average</span> <span class="n">reduction</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">reduction</span><span class="o">.</span><span class="na">getSum</span><span class="o">())</span> <span class="o">/</span> <span class="n">reduction</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">// Specifies the Encoder for the intermediate value type</span>
  <span class="kd">public</span> <span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Average</span><span class="o">&gt;</span> <span class="nf">bufferEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Average</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// Specifies the Encoder for the final output value type</span>
  <span class="kd">public</span> <span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">outputEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">DOUBLE</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">employeeEncoder</span> <span class="o">=</span> <span class="n">Encoders</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="o">;</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">json</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">employeeEncoder</span><span class="o">);</span>
<span class="n">ds</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="n">MyAverage</span> <span class="n">myAverage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyAverage</span><span class="o">();</span>
<span class="c1">// Convert the function to a `TypedColumn` and give it a name</span>
<span class="n">TypedColumn</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">averageSalary</span> <span class="o">=</span> <span class="n">myAverage</span><span class="o">.</span><span class="na">toColumn</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">&quot;average_salary&quot;</span><span class="o">);</span>
<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">averageSalary</span><span class="o">);</span>
<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
    <div><small>å¯ä»¥åœ¨Sparkä»“åº“çš„ "examples/src/main/java/org/apache/spark/examples/sql/JavaUserDefinedTypedAggregation.java" ä¸­æ‰¾åˆ°å®Œæ•´ä»£ç ã€‚</small></div>
  </div>
</div>
:ET